<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=808, user-scalable=no">
    <title>Gamebuino META Emulator</title>
    <style>
        body {
            margin: 10px;
            padding: 0;
            background-color: #4485cf;
        }

        #console { 
            width: 788px;
            height: 428px;
            background-image: url(console2.png);
            position: relative;
        }

        #emulator {
            position: absolute;
            top: 76px;
            left: 232px;
        }
    </style>
</head>

<body>
    <div id="console"><div id="emulator"></div></div>
    
    
    <script src="meta-emulator.js"></script>
    <script src="url-search-params.js"></script>

    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var emulator = new metaEmulator.Emulator("emulator");
        emulator.loadFromUrl(urlParams.has('bin') ? urlParams.get('bin') : "https://raw.githubusercontent.com/Rodot/Games-META/master/binaries/Solitaire/Solitaire.bin");

        const dpadX = 119;
        const dpadY = 216;
        const dpadDist = 87;

        const aX = 649;
        const aY = 233;

        const bX = 726;
        const bY = 199;

        const menuX = 297;
        const menuY = 382;

        const homeX = 505;
        const homeY = 382;

        const btnDist = 40;
        
        var controls = document.getElementById('console');

        controls.addEventListener("touchstart", handleTouches);
        controls.addEventListener("touchmove", handleTouches);
        controls.addEventListener("touchend", handleTouches);

        controls.addEventListener("mousedown", handleMouseDown);
        controls.addEventListener("mousemove", handleMouseMove);
        controls.addEventListener("mouseup", handleMouseUp);

        function squareDist(touch, x, y) {
            return (touch.pageX - x) * (touch.pageX - x) + (touch.pageY - y) * (touch.pageY - y);
        }

        var mousePressed = false;
        function handleMouseDown(event) {
            mousePressed = true;
            handleMouseMove(event);
        }

        function handleMouseMove(event) {
            if (mousePressed) emulator.setButtonData(handleTouch(event));
        }

        function handleMouseUp() {
            mousePressed = false;
            emulator.setButtonData(0b11111111);
        }

        function handleTouches(event) {
            event.preventDefault();

            var buttonData = 0b11111111;

            for (var touch of event.touches) {
                // console.log(touch.pageX + " " + touch.pageY);
                buttonData &= handleTouch(touch);
            }
            // console.log(buttonData.toString(2));
            emulator.setButtonData(buttonData);
        }

        function handleTouch(touch) {
            var direction = "";
            if (squareDist(touch, dpadX, dpadY) < dpadDist * dpadDist) {
                var angle = Math.atan2(dpadY - touch.pageY, touch.pageX - dpadX);
                
                if (angle < -7*Math.PI/8) {
                    return 0b11111101;
                }
                else if (angle < -5*Math.PI/8) {
                    return 0b11111100;
                }
                else if (angle < -3*Math.PI/8) {
                    return 0b11111110;
                }
                else if (angle < -Math.PI/8) {
                    return 0b11111010;
                }
                else if (angle < Math.PI/8) {
                    return 0b11111011;
                }
                else if (angle < 3*Math.PI/8) {
                    return 0b11110011;
                }
                else if (angle < 5*Math.PI/8) {
                    return 0b11110111;
                }
                else if (angle < 7*Math.PI/8) {
                    return 0b11110101;
                }
                else {
                    return 0b11111101;
                }
            }
            else if (squareDist(touch, aX, aY) < btnDist * btnDist) {
                return 0b11101111;
            }
            else if (squareDist(touch, bX, bY) < btnDist * btnDist) {
                return 0b11011111;
            }
            else if (squareDist(touch, menuX, menuY) < btnDist * btnDist) {
                return 0b10111111;
            }
            else if (squareDist(touch, homeX, homeY) < btnDist * btnDist) {
                return 0b01111111;
            }

            return 0b11111111;
        }
    </script>
</body>

</html>